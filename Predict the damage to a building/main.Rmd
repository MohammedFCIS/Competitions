---
title: "Predict the damage to a building"
author: "Mohammed Ali"
date: "July 3, 2018"
output:
  html_document:
    toc: true
    fig_width: 16
    fig_height: 10
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(DataExplorer)
library(knitr)
library(kableExtra)
library(caTools)
library(rpart)
library(rpart.plot)
library(ROCR)
library(randomForest)
library(caret)
library(e1071)
library(party)
library(relaimpo)
```

# EDA
First let us investigate training dataset, the main dataset.

```{r train_load_basic_structure}
train <- as_tibble(read.csv("data/train.csv"))
glimpse(train)
```
The logical feaures that start with *has* is of type double which will affect the later analysis badly, so let us convert them to a factor of 2 values (**0**, **1**)

```{r convert_logical_to_factors}
train[, 5:13] <- map_dfr(train[, 5:13], as.factor)
```

Let us investigate the data now 
```{r summary}
summary(train)
plot_str(train)
```

Ok, now we can perform our analysis on our dataset

## Data Profiling Report
### Basic Statistics
```{r Basic_Statistics}
stat <- introduce(train)
names(stat) <- c("Rows", "Columns", "Discrete columns", "Continuous columns", "All missing columns", "Missing observations", "Total observations", "Memory allocation")

gather(stat, Name, Value) %>%
  kable(format.args = list(decimal.mark = ".", big.mark = ",")) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

### Missing Data Profile
Though there are no many missing data, let us see how the missing rows are distributed.
```{r data_str}
plot_missing(train)
```


Strange engouh, all missing data in *has_reoair_started* feature which indicates that there is an issue in tracking these building reparing or they might be removed at all, let us see.

### Univariate Distribution
Let us see how the *univariate* is doing

#### Continuous Features
```{r uni_var}
plot_histogram(train)
```

and another view
```{r}
plot_density(train)
```
It is clear that there is more damged areas than others.

#### Discreate Features
```{r bar_chart}
plot_bar(train)
```

My Notes from above:

* I think we can exclude *has_repair_started* feaure, clearly it dose not contribute to the building damage degree.

* Other that *area_assessed* feature, features seems not to contribute too much to the target variable.

Let us see the correlation between them

#### Correlation Analysis
```{r cor_analysis}
plot_correlation(train)
```

From correlation analysis we found that:

* There is a strong positive correlaion between *Grade 1* damage and missing information in *has_repair_sarted* feature, and it seems like false correlation.

* *Grade 5* has strong positive correlation with *area_assessed_being_removed* and strong negative correlation with *area_assessed_both*

* Other correlations are so week.


let us include other complementary dataset and see the corrleations

## Feature Engieering
### Building Structure
Let us start by adding building structure features, first we read the dataset.
```{r building_structure}
structure <- as_tibble(read.csv("data/Building_Structure.csv"))
glimpse(structure)
```


We have 2 quick notes here:

* The number of observations is much more than the train dataset observations which mean it include observations of both train and test datasets. So, we either join the train and test dataset or split this dataset, I will select the first choice.

* We need to convert logical features into factors.

Let us combine train and test datasets
```{r train_test_join}
test <- as_tibble(read.csv("data/test.csv"))
test[, 4:12] <- map_dfr(test[, 4:12], as.factor)
buildings_all <- full_join(train, test)
```

It seems that there are 12 buildings in structure dataset have no records in the building datasets.
Now let us add structure features
```{r buildings_all_structures_join}
structure[, 18:28] <- map_dfr(structure[, 18:28], as.factor)
buildings_all <- full_join(buildings_all, structure)
```

### Building Ownership
Now let us add building ownership as well
```{r ownership}
ownership <- as_tibble(read.csv("data/Building_Ownership_Use.csv"))
glimpse(ownership)
```

Not let us combine it to the main dataset

```{r buildings_all_ownership_join}
ownership[, 5:17] <- map_dfr(ownership[, 5:17], as.factor)
buildings_all <- full_join(buildings_all, ownership)
#buildings_all[, c(16:18, 20:21)] <- map_dfr(buildings_all[, c(16:18, 20:21)], as.factor)
glimpse(buildings_all)
```

Now let us investigate the main dataset

### Basic Statistics
```{r all_sum}
summary(buildings_all)
```

### Full missing data profile

```{r all_missing}
plot_missing(buildings_all)
```
The missing information still in good rate, damage grade has 40% missing data because it belongs to the test data
### Full Continous Profile

```{r all_histogram}
plot_histogram(buildings_all)
```
There is defintely something wrong in the *pre* and *post* features

```{r all_density}
plot_density(buildings_all)
```


### Full Discreate Profile

```{r all_discreate}
plot_bar(buildings_all)
```

### Full Correlation Profile
`vdcmun_id`, `district_id` and `ward_id` has the identical effect we will use only one of them

```{r all_cor}
plot_correlation(buildings_all[,c("damage_grade", "height_ft_post_eq", "district_id", "count_floors_pre_eq", "age_building", "plinth_area_sq_ft", "height_ft_pre_eq","height_ft_post_eq" )])
```

```{r}
plot_correlation(buildings_all[, c(1:5)], type = "d")
plot_correlation(buildings_all[, c(3, 6:10)], type = "d")
plot_correlation(buildings_all[, c(3, 11:15)], type = "d")
plot_correlation(buildings_all[, c(3, 16:20)], type = "d")
plot_correlation(buildings_all[, c(3, 21:25)], type = "d")
plot_correlation(buildings_all[, c(3, 26:30)], type = "d")
plot_correlation(buildings_all[, c(3, 31:35)], type = "d")
plot_correlation(buildings_all[, c(3, 36:40)], type = "d")
plot_correlation(buildings_all[, c(3, 41:45)], type = "d")
plot_correlation(buildings_all[, c(3, 46:50)], type = "d")
plot_correlation(buildings_all[, c(3, 51:53)], type = "d")
```


# Building Training Dataset
Now we need to build the dataset in format that can be used in training and testing by converting all features into numeric ones.
```{r adding_area_assesed}
buildings_all_modified <- data.frame()
building_removed <- as.numeric(buildings_all$area_assesed == "Building removed")
Both <- as.numeric(buildings_all$area_assesed == "Both")
Exterior <- as.numeric(buildings_all$area_assesed == "Exterior")
Interior <- as.numeric(buildings_all$area_assesed == "Interior")
buildings_all_modified <- cbind(building_removed , Interior, Exterior, Both)
```

```{r damage_grade}
damage_grade <-as.numeric(buildings_all$damage_grade)
buildings_all_modified <- cbind(damage_grade, buildings_all_modified)
```

```{r land_surface_condition}
Moderate_slope <- as.numeric(buildings_all$land_surface_condition == "Moderate slope")
Steep_slope <- as.numeric(buildings_all$land_surface_condition == "Steep slope")
buildings_all_modified <- cbind(buildings_all_modified, Moderate_slope, Steep_slope)
```

```{r foundation_type}
Bamboo_Timber <- as.numeric(buildings_all$foundation_type == "Bamboo/Timber")
Cement_Stone_Brick <- as.numeric(buildings_all$foundation_type == "Cement-Stone/Brick")
Mud_mortar_Stone_Brick<- as.numeric(buildings_all$foundation_type == "Mud mortar-Stone/Brick")
RC <- as.numeric(buildings_all$foundation_type == "RC")
buildings_all_modified <- cbind(buildings_all_modified, Bamboo_Timber, Cement_Stone_Brick, Mud_mortar_Stone_Brick, RC)
```

```{r roof_type}
Bamboo_Timber_Heavy_roof <- as.numeric(buildings_all$roof_type == "Bamboo/Timber-Heavy roof")
Bamboo_Timber_Light_roof <- as.numeric(buildings_all$roof_type == "Bamboo/Timber-Light roof")
buildings_all_modified <- cbind(buildings_all_modified, Bamboo_Timber_Light_roof, Bamboo_Timber_Heavy_roof)
```

```{r ground_floor_type}
Brick_Stone <- as.numeric(buildings_all$ground_floor_type == "Brick/Stone")
Timber<- as.numeric(buildings_all$ground_floor_type == "Timber")
RC <- as.numeric(buildings_all$ground_floor_type == "RC")
buildings_all_modified <- cbind(buildings_all_modified, Brick_Stone, Timber, RC)
```

```{r other_floor_type}
RCC_RB_RBC <- as.numeric(buildings_all$other_floor_type == "RCC/RB/RBC")
Timber_Planck <- as.numeric(buildings_all$other_floor_type == "Timber-Planck")
TImber_Bamboo_Mud <- as.numeric(buildings_all$other_floor_type == "TImber/Bamboo-Mud")
buildings_all_modified <- cbind(buildings_all_modified, RCC_RB_RBC, TImber_Bamboo_Mud, Timber_Planck)
```

```{r position}
Attached_1 <- as.numeric(buildings_all$position == "Attached-1 side")
Attached_2 <- as.numeric(buildings_all$position == "Attached-2 side")
Attached_3 <- as.numeric(buildings_all$position == "Attached-3 side")
buildings_all_modified <- cbind(buildings_all_modified, Attached_1, Attached_2, Attached_3)
```


```{r plan_configuration}
Central_Courtyard <- as.numeric(buildings_all$plan_configuration == "Building with Central Courtyard")
E_shape <- as.numeric(buildings_all$plan_configuration == "E-shape")
H_shape<- as.numeric(buildings_all$plan_configuration == "H-shape")
L_shape <- as.numeric(buildings_all$plan_configuration == "L-shape")
T_shape <- as.numeric(buildings_all$plan_configuration == "T-shape")
U_shape <- as.numeric(buildings_all$plan_configuration == "U-shape")
Rectangular <- as.numeric(buildings_all$plan_configuration == "Rectangular")
Square <- as.numeric(buildings_all$plan_configuration == "Square")
Multi_projected <- as.numeric(buildings_all$plan_configuration == "Multi_projected")
buildings_all_modified <- cbind(buildings_all_modified, Central_Courtyard, E_shape, H_shape, L_shape, T_shape, U_shape, Rectangular, Square, Multi_projected)
```


```{r condition_post_eq}
Covered_by_landslide <- as.numeric(buildings_all$condition_post_eq == "Covered by landslide")
Damaged_Not_used <- as.numeric(buildings_all$condition_post_eq == "Damaged-Not used")
Damaged_Repaired_and_used <- as.numeric(buildings_all$condition_post_eq == "Damaged-Repaired and used")
Damaged_Rubble_clear<- as.numeric(buildings_all$condition_post_eq == "Damaged-Rubble clear")
Damaged_Rubble_unclear <- as.numeric(buildings_all$condition_post_eq == "Damaged-Rubble unclear")
Clear_New_building_built <- as.numeric(buildings_all$condition_post_eq == "Damaged-Rubble Clear-New building built")
Damaged_Used_in_risk <- as.numeric(buildings_all$condition_post_eq == "Damaged-Used in risk")
buildings_all_modified <- cbind(buildings_all_modified, Covered_by_landslide, Damaged_Used_in_risk, Damaged_Rubble_unclear, Damaged_Rubble_clear, Damaged_Repaired_and_used, Damaged_Not_used, Clear_New_building_built)
```


```{r legal_ownership_status}
Institutional <- as.numeric(buildings_all$legal_ownership_status == "Institutional")
Public <- as.numeric(buildings_all$legal_ownership_status == "Public")
Private <- as.numeric(buildings_all$legal_ownership_status == "Private")
buildings_all_modified <- cbind(buildings_all_modified, Institutional, Public, Private)
```

```{r other_features}
buildings_all_modified <- cbind(buildings_all_modified , map_dfr(buildings_all[, 5:13], as.numeric))
buildings_all_modified <- cbind(buildings_all_modified , map_dfr(buildings_all[, 29:39], as.numeric))
buildings_all_modified <- cbind(buildings_all_modified , map_dfr(buildings_all[, 42:53], as.numeric))
buildings_all_modified <- as.data.frame(buildings_all_modified)
```
# Feature Selection Approaches
Finding the most important predictor variables (of features) that explains major part of variance of the response variable is key to identify and build high performing models.

## Random Forest Method

fit the random forest
```{r}
training_all <- buildings_all[!is.na(buildings_all$damage_grade),]
testing_all <- buildings_all[is.na(buildings_all$damage_grade),]
```

```{r}
cf1 <- cforest(damage_grade ~ ., data= subset(training_all, select =  -c(building_id, district_id)), control=cforest_unbiased(mtry=2,ntree=50)) 
```

 
## Relative Importance
```{r}
lmMod <- lm(damage_grade ~ has_geotechnical_risk , data = training_all_new)  # fit lm() model
relImportance <- calc.relimp(lmMod, type = "lmg", rela = TRUE)  # calculate relative importance scaled to 100
sort(relImportance$lmg, decreasing=TRUE)  # relative importance
```


